<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>脚手架简介 | 码农机器人</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="努力向前">
    
    <link rel="preload" href="/assets/css/0.styles.b8d0645b.css" as="style"><link rel="preload" href="/assets/js/app.61a85b1c.js" as="script"><link rel="preload" href="/assets/js/2.6b359b12.js" as="script"><link rel="preload" href="/assets/js/67.74bf1c32.js" as="script"><link rel="prefetch" href="/assets/js/10.6bf522d2.js"><link rel="prefetch" href="/assets/js/100.a249a4e9.js"><link rel="prefetch" href="/assets/js/101.9d2465ad.js"><link rel="prefetch" href="/assets/js/102.5ea0ea92.js"><link rel="prefetch" href="/assets/js/103.ad073f03.js"><link rel="prefetch" href="/assets/js/104.afd1455c.js"><link rel="prefetch" href="/assets/js/105.5429d9b6.js"><link rel="prefetch" href="/assets/js/106.012719c5.js"><link rel="prefetch" href="/assets/js/107.fa002f10.js"><link rel="prefetch" href="/assets/js/108.9c70864a.js"><link rel="prefetch" href="/assets/js/109.ab6712ef.js"><link rel="prefetch" href="/assets/js/11.07adb038.js"><link rel="prefetch" href="/assets/js/110.3496849e.js"><link rel="prefetch" href="/assets/js/111.0708cccd.js"><link rel="prefetch" href="/assets/js/112.3ddda9ff.js"><link rel="prefetch" href="/assets/js/113.a826b4ec.js"><link rel="prefetch" href="/assets/js/114.54f06bf1.js"><link rel="prefetch" href="/assets/js/115.68bd2270.js"><link rel="prefetch" href="/assets/js/116.0e283e33.js"><link rel="prefetch" href="/assets/js/117.10ca7c11.js"><link rel="prefetch" href="/assets/js/118.0f21544b.js"><link rel="prefetch" href="/assets/js/119.3d5cdaf0.js"><link rel="prefetch" href="/assets/js/12.6a633ec9.js"><link rel="prefetch" href="/assets/js/13.2e8873e5.js"><link rel="prefetch" href="/assets/js/14.0ea5ac55.js"><link rel="prefetch" href="/assets/js/15.d24d1240.js"><link rel="prefetch" href="/assets/js/16.bfb99431.js"><link rel="prefetch" href="/assets/js/17.0bf6db21.js"><link rel="prefetch" href="/assets/js/18.f6a16197.js"><link rel="prefetch" href="/assets/js/19.15b1e095.js"><link rel="prefetch" href="/assets/js/20.56746f5a.js"><link rel="prefetch" href="/assets/js/21.5019bb92.js"><link rel="prefetch" href="/assets/js/22.36a83eaf.js"><link rel="prefetch" href="/assets/js/23.c1d826fa.js"><link rel="prefetch" href="/assets/js/24.66437f58.js"><link rel="prefetch" href="/assets/js/25.b5ef9760.js"><link rel="prefetch" href="/assets/js/26.1e34c193.js"><link rel="prefetch" href="/assets/js/27.ea4375e5.js"><link rel="prefetch" href="/assets/js/28.8e440e91.js"><link rel="prefetch" href="/assets/js/29.ffd2070e.js"><link rel="prefetch" href="/assets/js/3.a6d8cb97.js"><link rel="prefetch" href="/assets/js/30.c1451f4e.js"><link rel="prefetch" href="/assets/js/31.a21ecc83.js"><link rel="prefetch" href="/assets/js/32.5d1de9ff.js"><link rel="prefetch" href="/assets/js/33.f9eef1d1.js"><link rel="prefetch" href="/assets/js/34.edb8fde2.js"><link rel="prefetch" href="/assets/js/35.6950ed93.js"><link rel="prefetch" href="/assets/js/36.b394a848.js"><link rel="prefetch" href="/assets/js/37.f11aa33f.js"><link rel="prefetch" href="/assets/js/38.e86bdf7f.js"><link rel="prefetch" href="/assets/js/39.dbc9c882.js"><link rel="prefetch" href="/assets/js/4.f3783df1.js"><link rel="prefetch" href="/assets/js/40.470a2b37.js"><link rel="prefetch" href="/assets/js/41.bcffb885.js"><link rel="prefetch" href="/assets/js/42.484ee502.js"><link rel="prefetch" href="/assets/js/43.2a86b409.js"><link rel="prefetch" href="/assets/js/44.2b684e4d.js"><link rel="prefetch" href="/assets/js/45.4e6fb818.js"><link rel="prefetch" href="/assets/js/46.86268f46.js"><link rel="prefetch" href="/assets/js/47.84f7cda3.js"><link rel="prefetch" href="/assets/js/48.fd78be04.js"><link rel="prefetch" href="/assets/js/49.f5a6fc1e.js"><link rel="prefetch" href="/assets/js/5.892f2cf8.js"><link rel="prefetch" href="/assets/js/50.29919944.js"><link rel="prefetch" href="/assets/js/51.c1b5918c.js"><link rel="prefetch" href="/assets/js/52.c4ad64f8.js"><link rel="prefetch" href="/assets/js/53.df154372.js"><link rel="prefetch" href="/assets/js/54.4fee1b96.js"><link rel="prefetch" href="/assets/js/55.18c6e9f2.js"><link rel="prefetch" href="/assets/js/56.d5569485.js"><link rel="prefetch" href="/assets/js/57.9eb74b69.js"><link rel="prefetch" href="/assets/js/58.c8b7968e.js"><link rel="prefetch" href="/assets/js/59.a208d99c.js"><link rel="prefetch" href="/assets/js/6.a9a81823.js"><link rel="prefetch" href="/assets/js/60.c0f7048b.js"><link rel="prefetch" href="/assets/js/61.e06e2c12.js"><link rel="prefetch" href="/assets/js/62.3726a0b9.js"><link rel="prefetch" href="/assets/js/63.53a81692.js"><link rel="prefetch" href="/assets/js/64.ba6af384.js"><link rel="prefetch" href="/assets/js/65.2f165ffa.js"><link rel="prefetch" href="/assets/js/66.8c0a983a.js"><link rel="prefetch" href="/assets/js/68.27c15e0b.js"><link rel="prefetch" href="/assets/js/69.5b78d6fb.js"><link rel="prefetch" href="/assets/js/7.a9e85c97.js"><link rel="prefetch" href="/assets/js/70.4772f9bd.js"><link rel="prefetch" href="/assets/js/71.2a2e89e4.js"><link rel="prefetch" href="/assets/js/72.3debedf0.js"><link rel="prefetch" href="/assets/js/73.c9ee93ce.js"><link rel="prefetch" href="/assets/js/74.7ec9495c.js"><link rel="prefetch" href="/assets/js/75.8c828ff5.js"><link rel="prefetch" href="/assets/js/76.986dc0d7.js"><link rel="prefetch" href="/assets/js/77.7e7e3c8e.js"><link rel="prefetch" href="/assets/js/78.200d9828.js"><link rel="prefetch" href="/assets/js/79.ee6b28e9.js"><link rel="prefetch" href="/assets/js/8.448002b9.js"><link rel="prefetch" href="/assets/js/80.93d03d67.js"><link rel="prefetch" href="/assets/js/81.eebcba15.js"><link rel="prefetch" href="/assets/js/82.3b0bb838.js"><link rel="prefetch" href="/assets/js/83.75234d18.js"><link rel="prefetch" href="/assets/js/84.1a897e55.js"><link rel="prefetch" href="/assets/js/85.8267b168.js"><link rel="prefetch" href="/assets/js/86.a7557c20.js"><link rel="prefetch" href="/assets/js/87.4f7e77b3.js"><link rel="prefetch" href="/assets/js/88.9b41f10e.js"><link rel="prefetch" href="/assets/js/89.662b9425.js"><link rel="prefetch" href="/assets/js/9.804860d0.js"><link rel="prefetch" href="/assets/js/90.6d84e2d8.js"><link rel="prefetch" href="/assets/js/91.650a7b6f.js"><link rel="prefetch" href="/assets/js/92.8568032c.js"><link rel="prefetch" href="/assets/js/93.0c300b40.js"><link rel="prefetch" href="/assets/js/94.f7ce23ff.js"><link rel="prefetch" href="/assets/js/95.e6c8272f.js"><link rel="prefetch" href="/assets/js/96.8f51c3ac.js"><link rel="prefetch" href="/assets/js/97.9cc683f5.js"><link rel="prefetch" href="/assets/js/98.6af1269f.js"><link rel="prefetch" href="/assets/js/99.97a09de8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b8d0645b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="码农机器人" class="logo"> <span class="site-name can-hide">码农机器人</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>建立前端知识体系</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>提效赋能 前端工程化篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/modular/脚手架.html" class="active sidebar-link">脚手架简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架简介" class="sidebar-link">脚手架简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#什么是脚手架" class="sidebar-link">什么是脚手架?</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架的执行原理" class="sidebar-link">脚手架的执行原理</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架的实现原理" class="sidebar-link">脚手架的实现原理</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架的作用" class="sidebar-link">脚手架的作用</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#核心价值" class="sidebar-link">核心价值</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架开发难点解析" class="sidebar-link">脚手架开发难点解析</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架本地link标准流程" class="sidebar-link">脚手架本地link标准流程</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#原生脚手架开发痛点分析" class="sidebar-link">原生脚手架开发痛点分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#lerna简介" class="sidebar-link">Lerna简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#优势" class="sidebar-link">优势</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#learn开发脚手架流程" class="sidebar-link">learn开发脚手架流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架开发" class="sidebar-link">脚手架开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架架构图" class="sidebar-link">脚手架架构图</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架拆包策略" class="sidebar-link">脚手架拆包策略</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#命令执行流程" class="sidebar-link">命令执行流程</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#命令注册" class="sidebar-link">命令注册</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#命令执行阶段" class="sidebar-link">命令执行阶段</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#脚手架项目创建功能设计" class="sidebar-link">脚手架项目创建功能设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#创建项目功能架构设计图" class="sidebar-link">创建项目功能架构设计图</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#附" class="sidebar-link">附</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#如何通过yargs来开发脚手架" class="sidebar-link">如何通过Yargs来开发脚手架?</a></li><li class="sidebar-sub-header"><a href="/note/modular/脚手架.html#node-js模块路径解析流程" class="sidebar-link">Node.js模块路径解析流程</a></li></ul></li></ul></li><li><a href="/note/modular/自动化部署.html" class="sidebar-link">自动化部署</a></li><li><a href="/note/modular/gitlab自动化.html" class="sidebar-link">gitlab自动化</a></li><li><a href="/note/modular/Jenkins.html" class="sidebar-link">Jenkins</a></li><li><a href="/note/modular/Sonar简单使用.html" class="sidebar-link">Sonar简单使用</a></li><li><a href="/note/modular/前端工程与构建.html" class="sidebar-link">前端工程与构建</a></li><li><a href="/note/modular/前端工程与性能优化.html" class="sidebar-link">前端工程与性能优化</a></li><li><a href="/note/modular/敏捷开发持续集成.html" class="sidebar-link">敏捷开发、持续集成</a></li><li><a href="/note/modular/工程化基础.html" class="sidebar-link">工程化基础</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>程序员PLUS篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>忍者秘籍书</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="脚手架简介"><a href="#脚手架简介" class="header-anchor">#</a> 脚手架简介</h2> <h3 id="什么是脚手架"><a href="#什么是脚手架" class="header-anchor">#</a> 什么是脚手架?</h3> <p>脚手架本质是一个操作系统的客户端，它通过命令行执行，就比如:</p> <div class="language-js extra-class"><pre class="language-js"><code>vue create vue<span class="token operator">-</span>test<span class="token operator">-</span>app
</code></pre></div><p>上面这条命令由3个部分组成:</p> <ul><li>主命令:vue</li> <li>command:create</li> <li>command的param:vue-test-app</li></ul> <h3 id="脚手架的执行原理"><a href="#脚手架的执行原理" class="header-anchor">#</a> 脚手架的执行原理</h3> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe45161a2cb54281afc184bdd3536538~tplv-k3u1fbpfcp-watermark.image" alt="5fda202309d65fff16991502.png"></p> <p>脚手架的执行原理如下:</p> <ul><li>在终端输入vue create vue-test-app</li> <li>终端解析出vue命令</li> <li>终端在环境变量中找到vue命令</li> <li>最终根据vue命令链接到实际文件vue.js</li> <li>终端利用node执行vue.js</li> <li>vue.js解析command/options</li> <li>vue.js执行command</li> <li>执行完毕，退出执行</li></ul> <h3 id="脚手架的实现原理"><a href="#脚手架的实现原理" class="header-anchor">#</a> 脚手架的实现原理</h3> <h4 id="为什么全局安装-vue-cli后会添加的命令为vue"><a href="#为什么全局安装-vue-cli后会添加的命令为vue" class="header-anchor">#</a> 为什么全局安装<code>@vue/cli</code>后会添加的命令为<code>vue</code>?</h4> <p>首先我们通过<code>which vue</code>找到<code>vue</code>的目录<code>/usr/local/bin/vue</code>,然后进入到<code>/usr/local/bin</code>目录下，查看下面所有内容，其中有一条这样的链接<code>vue -&gt; ../lib/node_modules/@vue/cli/bin/vue.js</code>,<code>vue</code>软连接到全局安装目录，去执行<code>vue.js</code>，这种绑定关系是在那确定的呢?我们进入到<code>../lib/node_modules/@vue/cli/</code>，查看<code>package.json</code>，我们看到<code>&quot;bin&quot;: { &quot;vue&quot;: &quot;bin/vue.js&quot; },</code>,这个<code>bin</code>当中配置的就是我们在操作系统中安装完成后软连接的名称以及指向的实际文件</p> <h4 id="全局安装-vue-cli时发生了什么"><a href="#全局安装-vue-cli时发生了什么" class="header-anchor">#</a> 全局安装<code>@vue/cli</code>时发生了什么?</h4> <div class="language-js extra-class"><pre class="language-js"><code>npm install <span class="token operator">-</span>g @vue<span class="token operator">/</span>cli
</code></pre></div><p>首先npm把我们当前的包下载到<code>node_modules</code>目录里面，如果是全局安装的<code>node</code>,它可能存在<code>/uer/lib/</code>目录下，当把这个包完全下载完毕之后，它会去解析<code>package.json</code>里面的<code>bin</code>，如果说<code>bin</code>下面有配置，它就会在我们<code>node</code>安装目录下的<code>bin</code>目录里面创建一个软连接.</p> <h4 id="执行vue命令时发生了什么-为什么vue指向了js文件-我们却可以直接通过vue命令去执行它"><a href="#执行vue命令时发生了什么-为什么vue指向了js文件-我们却可以直接通过vue命令去执行它" class="header-anchor">#</a> 执行<code>vue</code>命令时发生了什么?为什么<code>vue</code>指向了<code>js</code>文件，我们却可以直接通过<code>vue</code>命令去执行它?</h4> <p>第一个问题:执行<code>vue</code>的时候，我们操作系统会通过<code>which vue</code>去找到<code>bin</code>目录下的文件执行，也就是说去环境变量中找<code>vue</code>是否被注册，注册了就执行.</p> <p>第二个问题:因为在文件上方加入了<code>!/usr/bin/env node</code>环境变量，这个环境变量可以让我们通过固定的命名去对它进行执行</p> <p>扩展一下，下面两种写法的区别:</p> <div class="language-js extra-class"><pre class="language-js"><code>  #<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
  #<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>node
</code></pre></div><p>第一种是在环境变量中查找<code>node</code></p> <p>第二种是直接执行<code>/usr/bin/</code>目录下的<code>node</code></p> <h3 id="脚手架的作用"><a href="#脚手架的作用" class="header-anchor">#</a> 脚手架的作用</h3> <p>开发脚手架的核心目标是: <strong>提升前端研发效能</strong></p> <h3 id="核心价值"><a href="#核心价值" class="header-anchor">#</a> 核心价值</h3> <ul><li>自动化:项目重复代码拷贝/git操作/发布上线操作</li> <li>标准化:项目创建/git flow/发布流程/回滚流程</li> <li>数据化:研发过程系统化、数据化，使得研发过程可量化</li></ul> <h3 id="脚手架开发难点解析"><a href="#脚手架开发难点解析" class="header-anchor">#</a> 脚手架开发难点解析</h3> <ul><li>分包:将复杂的系统拆分成若干个模块</li> <li>命令注册:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>vue create
vue add
vue invoke
</code></pre></div><ul><li>参数解析:
<ul><li>options全称:<code>--version</code>、<code>--help</code></li> <li>options简写:<code>-V</code>、<code>-h</code></li> <li>带params的options: -path xxxx</li></ul></li> <li>帮助文档</li> <li>命令行交互</li> <li>日志打印</li> <li>命令行文字变色</li> <li>网络通信:HTTP/WebSocket</li> <li>文件处理
等等...</li></ul> <h3 id="脚手架本地link标准流程"><a href="#脚手架本地link标准流程" class="header-anchor">#</a> 脚手架本地link标准流程</h3> <p>链接本地脚手架：</p> <div class="language-js extra-class"><pre class="language-js"><code>cd your<span class="token operator">-</span>cli<span class="token operator">-</span>dir
npm link
</code></pre></div><p>链接本地库文件:</p> <div class="language-js extra-class"><pre class="language-js"><code>cd your<span class="token operator">-</span>cli<span class="token operator">-</span>dir
npm link
cd your<span class="token operator">-</span>cli<span class="token operator">-</span>dir
npm link your<span class="token operator">-</span>lib
</code></pre></div><p>取消链接本地库文件:</p> <div class="language-js extra-class"><pre class="language-js"><code>cd your<span class="token operator">-</span>cli<span class="token operator">-</span>dir
npm unlink
cd your<span class="token operator">-</span>cli<span class="token operator">-</span>dir
# link存在
npm unlink your<span class="token operator">-</span>lib
# link不存在
rm <span class="token operator">-</span>rf node_modules
npm install <span class="token operator">-</span><span class="token constant">S</span> your<span class="token operator">-</span>lib
</code></pre></div><p>理解<code>npm link</code>:</p> <ul><li><code>npm link your-lib</code>: 将当前项目中的<code>node_modules</code>下指定的库文件链接到<code>node</code>全局<code>node_modules</code>下的库文件</li> <li><code>npm link</code>: 将当前项目链接到<code>node</code>全局<code>node_modules</code>中作为一个库文件，并解析<code>bin</code>配置创建可执行文件</li></ul> <p>理解<code>npm unlink</code>:</p> <ul><li><code>npm unlink</code>: 将当前项目从<code>node</code>全局<code>node_modules</code>中移除</li> <li><code>npm unlink your-lib</code>: 将当前项目中的库文件依赖移除</li></ul> <h3 id="原生脚手架开发痛点分析"><a href="#原生脚手架开发痛点分析" class="header-anchor">#</a> 原生脚手架开发痛点分析</h3> <ul><li>痛点一:重复操作
<ul><li>多Package本地link</li> <li>多Package依赖安装</li> <li>多Package单元测试</li> <li>多Package代码提交</li> <li>多Package代码发布</li></ul></li> <li>痛点二:版本一致性问题
<ul><li>发布时版本一致性</li> <li>发布后相互依赖版本升级</li></ul></li></ul> <p>分析可痛点，那么就会有解决办法，那就是通过Lerna来管理多Package。</p> <h2 id="lerna简介"><a href="#lerna简介" class="header-anchor">#</a> Lerna简介</h2> <p>Lerna是一个优化基于git+npm的多package项目的管理工具，使用Lerna管理的大型项目有:<a href="https://github.com/babel/babel" target="_blank" rel="noopener noreferrer">babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,<a href="https://github.com/vuejs/vue-cli" target="_blank" rel="noopener noreferrer">vue-cli<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,<a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener noreferrer">craete-react-app<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>等等。</p> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <ul><li>通过import-local优先调用本地lerna命令</li> <li>通过Yargs生成脚手架，先注册全局属性，再注册命令，最后通过parse方法解析参数</li> <li>lerna 命令注册时需要传入builder和handler两个方法，builder方法用于注册命令专属的options,handler用来处理命令业务的逻辑</li> <li>lerna通过配置npm本地依赖的方法来进行本地开发，具体写法是在package.json的依赖中写入:<code>file:your-local-module-path</code>,在<code>lerna public</code>的时候自动将该路径替换</li></ul> <h3 id="优势"><a href="#优势" class="header-anchor">#</a> 优势</h3> <ul><li>大幅减少重复操作</li> <li>提升操作的标准化</li></ul> <h3 id="learn开发脚手架流程"><a href="#learn开发脚手架流程" class="header-anchor">#</a> learn开发脚手架流程</h3> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba8f1b21e02f4b23a8a09e67eeab0fb0~tplv-k3u1fbpfcp-watermark.image" alt="5fda20d609a8a01307221197.png"></p> <h2 id="脚手架开发"><a href="#脚手架开发" class="header-anchor">#</a> 脚手架开发</h2> <p>在开发脚手架之前，我们先了解下脚手架开发的流程图。</p> <h3 id="脚手架架构图"><a href="#脚手架架构图" class="header-anchor">#</a> 脚手架架构图</h3> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f0ee1e34a4c4328a441b97924ecba9a~tplv-k3u1fbpfcp-watermark.image" alt="脚手架设计图.png"></p> <h3 id="脚手架拆包策略"><a href="#脚手架拆包策略" class="header-anchor">#</a> 脚手架拆包策略</h3> <ul><li>核心流程:core</li> <li>命令:commands
<ul><li>初始化</li> <li>发布</li> <li>清除缓存</li></ul></li> <li>模型层:models
<ul><li>Command命令</li> <li>Project项目</li> <li>Component组件</li> <li>Npm模块</li> <li>Git仓库</li></ul></li> <li>支持模块:utils
<ul><li>Git操作</li> <li>云构建</li> <li>工具方法</li> <li>API请求</li> <li>Git API</li></ul></li></ul> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0e6a1e6d5224a9b8e6543a05de12923~tplv-k3u1fbpfcp-watermark.image" alt="1620572867252.jpg"></p> <h3 id="命令执行流程"><a href="#命令执行流程" class="header-anchor">#</a> 命令执行流程</h3> <ul><li><p>准备阶段
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1fabe362adf4936a51c65a2dbbb2756~tplv-k3u1fbpfcp-watermark.image" alt="core准备阶段.png"></p></li> <li><p>命令注册
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7075f516f73646efa37d685c2bdd7735~tplv-k3u1fbpfcp-watermark.image" alt="core命令阶段.png"></p></li> <li><p>命令执行</p></li></ul> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/187856b175294650a404033e213c3c2c~tplv-k3u1fbpfcp-watermark.image" alt="5fe4a3a408c7620016001303.jpeg"></p> <h4 id="准备阶段"><a href="#准备阶段" class="header-anchor">#</a> 准备阶段</h4> <ul><li>检查版本号</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查版本</span>
<span class="token keyword">function</span> <span class="token function">checkPkgVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'cli'</span><span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查node版本</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查node版本</span>
<span class="token function">checkNodeVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//第一步，获取当前Node版本号</span>
    <span class="token keyword">const</span> currentVersion <span class="token operator">=</span> process<span class="token punctuation">.</span>version<span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastVersion <span class="token operator">=</span> <span class="token constant">LOWEST_NODE_VERSION</span><span class="token punctuation">;</span>
    <span class="token comment">//第二步，对比最低版本号</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>currentVersion<span class="token punctuation">,</span> lastVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">roy-cli-dev 需要安装v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">以上版本的Node.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查root权限</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查root启动</span>
<span class="token keyword">function</span> <span class="token function">checkRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//使用后，检查到root账户启动，会进行降级为用户账户</span>
    <span class="token keyword">const</span> rootCheck <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'root-check'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rootCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查用户主目录</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查用户主目录</span>
<span class="token keyword">function</span> <span class="token function">checkUserHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userHome <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">pathExists</span><span class="token punctuation">(</span>userHome<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'当前登录用户主目录不存在!!!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查入参</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查入参</span>
<span class="token keyword">function</span> <span class="token function">checkInputArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> minimist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'minimist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args <span class="token operator">=</span> <span class="token function">minimist</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">=</span> <span class="token string">'verbose'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span>level <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查环境变量</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查环境变量</span>
<span class="token keyword">function</span> <span class="token function">checkEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dotenvPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span> <span class="token string">'.env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pathExists</span><span class="token punctuation">(</span>dotenvPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        config <span class="token operator">=</span> dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> dotenvPath
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">createDefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'环境变量'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createDefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cliConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">home</span><span class="token operator">:</span> userHome
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cliConfig<span class="token punctuation">[</span><span class="token string">'cliHome'</span><span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cliConfig<span class="token punctuation">[</span><span class="token string">'cliHome'</span><span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span> constants<span class="token punctuation">.</span><span class="token constant">DEFAULT_CLI_HOME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME_PATH</span> <span class="token operator">=</span> cliConfig<span class="token punctuation">.</span>cliHome<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>检查是否是最新版本</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检查是否是最新版本，是否需要更新</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkGlobalUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.获取当前版本号和模块名</span>
    <span class="token keyword">const</span> currentVersion <span class="token operator">=</span> pkg<span class="token punctuation">.</span>version<span class="token punctuation">;</span>
    <span class="token keyword">const</span> npmName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token comment">//2.调用npm API,获取所有版本号</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> getNpmSemverVersion <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@roy-cli-dev/get-npm-info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.提取所有版本号，比对哪些版本号是大于当前版本号</span>
    <span class="token keyword">const</span> lastVersion <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getNpmSemverVersion</span><span class="token punctuation">(</span>currentVersion<span class="token punctuation">,</span> npmName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastVersion <span class="token operator">&amp;&amp;</span> semver<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span>lastVersion<span class="token punctuation">,</span> currentVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//4.获取最新的版本号，提示用户更新到该版本</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请手动更新</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>npmName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,当前版本:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,最新版本:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 
                    更新命令:npm install -g </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>npmName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="命令注册"><a href="#命令注册" class="header-anchor">#</a> 命令注册</h3> <p>注册init阶段</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//命名的注册</span>
<span class="token keyword">function</span> <span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    program
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt; [options]'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --debug'</span><span class="token punctuation">,</span> <span class="token string">'是否开启调试模式'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-tp, --targetPath &lt;targetPath&gt;'</span><span class="token punctuation">,</span> <span class="token string">'是否指定本地调试文件路径'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    program
        <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'init [projectName]'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f, --force'</span><span class="token punctuation">,</span> <span class="token string">'是否强制初始化项目'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//init 单独解析一个命令 exec动态加载模块</span>


    <span class="token comment">//开启debug模式</span>
    program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'option:debug'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>program<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">=</span> <span class="token string">'verbose'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span>level <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//指定targetPath</span>
    program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'option:targetPath'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span> <span class="token operator">=</span> program<span class="token punctuation">.</span>targetPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//对未知命令的监听</span>
    program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'command:*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> availabelCommands <span class="token operator">=</span> program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'未知命令:'</span> <span class="token operator">+</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>availabelCommands<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">blue</span><span class="token punctuation">(</span><span class="token string">'可用命令:'</span> <span class="token operator">+</span> availabelCommands<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用户没有输入命令的时候</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>program<span class="token punctuation">.</span>args <span class="token operator">&amp;&amp;</span> program<span class="token punctuation">.</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        program<span class="token punctuation">.</span><span class="token function">outputHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="当前架构图"><a href="#当前架构图" class="header-anchor">#</a> 当前架构图</h4> <p>通过准备阶段和命令初始化init阶段，我们创建了如下一些package:
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd0d785604eb4d26b8109df2b84b9c21~tplv-k3u1fbpfcp-watermark.image" alt="5fe4a37908dd3d1b13720561.jpeg"></p> <p>这样的架构设计已经可以满足一般脚手架需求，但是有以下两个问题:</p> <p>1.cli安装速度慢:所有的package都集成在cli里，因此当命令较多时，会减慢cli的安装速度</p> <p>2.灵活性差:init命令只能使用@roy-cli-dev/init包，对于集团公司而言，每个bu的init命令可能都各不相同，可能需要实现init命令动态化，如:</p> <ul><li>团队A使用@roy-cli-dev/init作为初始化模板</li> <li>团队B使用自己开发的@roy-cli-dev/my-init作为初始化模板</li> <li>团队C使用自己开发的@roy-cli-dev/your-init作为初始化模板</li></ul> <p>这时对我们的架构设计就提出了挑战，要求我们能够动态加载init模块，这将增加架构的复杂度，但大大提升脚手架的可扩展性，将脚手架框架和业务逻辑解耦</p> <h4 id="脚手架架构优化"><a href="#脚手架架构优化" class="header-anchor">#</a> 脚手架架构优化</h4> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/22df52ee6bed49abbeb20fb93951af32~tplv-k3u1fbpfcp-watermark.image" alt="jiaoshoujiayouhua.png"></p> <h3 id="命令执行阶段"><a href="#命令执行阶段" class="header-anchor">#</a> 命令执行阶段</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">SETTINGS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">init</span><span class="token operator">:</span> <span class="token string">&quot;@roy-cli-dev/init&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">CACHE_DIR</span> <span class="token operator">=</span> <span class="token string">'dependencies/'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> targetPath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_TARGET_PATH</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> homePath <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLI_HOME_PATH</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> storeDir <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pkg<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'targetPath'</span><span class="token punctuation">,</span> targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'homePath'</span><span class="token punctuation">,</span> homePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdObj <span class="token operator">=</span> arguments<span class="token punctuation">[</span>arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cmdName <span class="token operator">=</span> cmdObj<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token constant">SETTINGS</span><span class="token punctuation">[</span>cmdName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> packageVersion <span class="token operator">=</span> <span class="token string">'latest'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetPath<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//是否执行本地代码</span>
        <span class="token comment">//生成缓存路径</span>
        targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>homePath<span class="token punctuation">,</span> <span class="token constant">CACHE_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        storeDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> storeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化Package对象</span>
        pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            targetPath<span class="token punctuation">,</span>
            storeDir<span class="token punctuation">,</span>
            packageName<span class="token punctuation">,</span>
            packageVersion
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断Package是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//更新package</span>
            <span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//安装package</span>
            <span class="token keyword">await</span> pkg<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            targetPath<span class="token punctuation">,</span>
            packageName<span class="token punctuation">,</span>
            packageVersion
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取入口文件</span>
    <span class="token keyword">const</span> rootFile <span class="token operator">=</span> pkg<span class="token punctuation">.</span><span class="token function">getRootFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断入口文件是否存在</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//在当前进程中调用</span>
            <span class="token comment">// require(rootFile).call(null, Array.from(arguments));</span>
            <span class="token comment">//在node子进程中调用</span>
            <span class="token keyword">const</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> cmd <span class="token operator">=</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> o <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token string">'parent'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    o<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cmd<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> o<span class="token punctuation">;</span>
            <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rootFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">').call(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-e'</span><span class="token punctuation">,</span>code<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
                <span class="token literal-property property">cwd</span><span class="token operator">:</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">stdio</span><span class="token operator">:</span><span class="token string">'inherit'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//执行产生异常</span>
            child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//执行完毕 正常退出</span>
            child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'命令执行成功:'</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>


    <span class="token comment">//1.targetPath -&gt; modulePath</span>
    <span class="token comment">//2.modulePath -&gt; Package(npm模块)</span>
    <span class="token comment">//3.Package.getRootFile(获取入口文件)</span>
    <span class="token comment">//4.Package.update/Package.install</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="脚手架项目创建功能设计"><a href="#脚手架项目创建功能设计" class="header-anchor">#</a> 脚手架项目创建功能设计</h2> <p>首先我们要思考下脚手架项目创建为了什么:</p> <ul><li>可扩展性:能够快速复用到不同团队，适应不同团队之间的差异</li> <li>低成本:在不改动脚手架源码的情况下，能够新增模板，且新增模板的成本很低</li> <li>高性能:控制存储空间，安装时充分利用Node多进程提升安装性能</li></ul> <h3 id="创建项目功能架构设计图"><a href="#创建项目功能架构设计图" class="header-anchor">#</a> 创建项目功能架构设计图</h3> <p>整体过程分为三个阶段：</p> <ul><li>准备阶段</li></ul> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d58c7cf68c524a70a23d0917c96f9349~tplv-k3u1fbpfcp-watermark.image" alt="prepare.png"></p> <ul><li>下载模块</li></ul> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4fb85389287744e5a1229184bcf5721d~tplv-k3u1fbpfcp-watermark.image" alt="downloadTemplate.png"></p> <ul><li>安装模块</li></ul> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4e348dd438e47478268759f9ab7b917~tplv-k3u1fbpfcp-watermark.image" alt="installTemplate.png"></p> <h4 id="准备阶段-2"><a href="#准备阶段-2" class="header-anchor">#</a> 准备阶段</h4> <p>准备阶段的核心工作就是:</p> <ul><li>确保项目的安装环境</li> <li>确认项目的基本信息</li></ul> <h4 id="下载模块"><a href="#下载模块" class="header-anchor">#</a> 下载模块</h4> <p>下载模块是利用已经封装Package类快速实现相关功能</p> <h4 id="安装模块"><a href="#安装模块" class="header-anchor">#</a> 安装模块</h4> <p>安装模块分为标准模式和自定义模式:</p> <ul><li>标准模式下，将通过ejs实现模块渲染，并自动安装依赖并启动项目</li> <li>自定义模式下，将允许用户主动去实现模块的安装过程和后续启动过程</li></ul> <p>核心代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">InitCommand</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>projectName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>force <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cmd<span class="token punctuation">.</span>force<span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'projectName'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'force'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>force<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.准备阶段</span>
            <span class="token keyword">const</span> projectInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>projectInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//2.下载模板</span>
                log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'projectInfo'</span><span class="token punctuation">,</span> projectInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>projectInfo <span class="token operator">=</span> projectInfo
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">downloadTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3.安装模板</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">===</span> <span class="token string">'verbose'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">installTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'templateInfo'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token constant">TEMPLATE_TYPE_NORMAL</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">TEMPLATE_TYPE_NORMAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//标准安装   </span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installNormalTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">TEMPLATE_TYPE_CUSTOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//自定义安装</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installCustomTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'无法失败项目模板类'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'项目模板信息不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">checkCommand</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">WHITE_COMMAND</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cmd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> errMsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cmdArray <span class="token operator">=</span> command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkCommand</span><span class="token punctuation">(</span>cmdArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'命令不存在!命令:'</span> <span class="token operator">+</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> args <span class="token operator">=</span> cmdArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execAsync</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">cwd</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">ejsRender</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dir <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> projectInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectInfo<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">cwd</span><span class="token operator">:</span> dir<span class="token punctuation">,</span>
                <span class="token literal-property property">ignore</span><span class="token operator">:</span> options<span class="token punctuation">.</span>ignore <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
                <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve1<span class="token punctuation">,</span> reject1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> projectInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">reject1</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                fse<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">resolve1</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">installNormalTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//拷贝模板代码直当前目录</span>
        <span class="token keyword">let</span> spinner <span class="token operator">=</span> <span class="token function">spinnerStart</span><span class="token punctuation">(</span><span class="token string">'正在安装模板'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'templateNpm'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span>cachFilePath<span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> targetPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fse<span class="token punctuation">.</span><span class="token function">ensureDirSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//确保当前文件存不存在，不存在会创建</span>
            fse<span class="token punctuation">.</span><span class="token function">ensureDirSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fse<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把缓存目录下的模板拷贝到当前目录</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'模板安装成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> templateIgnore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo<span class="token punctuation">.</span>ignore <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> ignore <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'**/node_modules/**'</span><span class="token punctuation">,</span> <span class="token operator">...</span>templateIgnore<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ejsRender</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ignore <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//依赖安装</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> installCommand<span class="token punctuation">,</span> startCommand <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>installCommand<span class="token punctuation">,</span> <span class="token string">'依赖安装过程中失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动命令执行</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>startCommand<span class="token punctuation">,</span> <span class="token string">'启动执行命令失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">installCustomTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询自定义模板的入口文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> rootFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm<span class="token punctuation">.</span><span class="token function">getRootFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>rootFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">notice</span><span class="token punctuation">(</span><span class="token string">'开始执行自定义模板'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>
                    <span class="token literal-property property">cwd</span><span class="token operator">:</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rootFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">execAsync</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'-e'</span><span class="token punctuation">,</span> code<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'自定义模板安装成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'自定义模板入口文件不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">downloadTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1. 通过项目模板API获取项目模板信息</span>
        <span class="token comment">//1.1 通过egg.js搭建一套后端系统</span>
        <span class="token comment">//1.2 通过npm存储项目模板</span>
        <span class="token comment">//1.3 将项目模板信息存储到mongodb数据库中</span>
        <span class="token comment">//1.4 通过egg.js获取mongodb中的数据并且通过API返回</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> projectTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectInfo<span class="token punctuation">;</span>
        <span class="token keyword">const</span> templateInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>npmName <span class="token operator">===</span> projectTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span> <span class="token string">'.roy-cli-dev'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> storeDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userHome<span class="token punctuation">,</span> <span class="token string">'.roy-cli-dev'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> npmName<span class="token punctuation">,</span> version <span class="token punctuation">}</span> <span class="token operator">=</span> templateInfo<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>templateInfo <span class="token operator">=</span> templateInfo<span class="token punctuation">;</span>
        <span class="token keyword">const</span> templateNpm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            targetPath<span class="token punctuation">,</span>
            storeDir<span class="token punctuation">,</span>
            <span class="token literal-property property">packageName</span><span class="token operator">:</span> npmName<span class="token punctuation">,</span>
            <span class="token literal-property property">packageVersion</span><span class="token operator">:</span> version
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token keyword">await</span> templateNpm<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">spinnerStart</span><span class="token punctuation">(</span><span class="token string">'正在下载模板...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> templateNpm<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>templateNpm<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'下载模板成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm <span class="token operator">=</span> templateNpm<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">spinnerStart</span><span class="token punctuation">(</span><span class="token string">'正在更新模板...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> templateNpm<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>templateNpm<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'更新模板成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>templateNpm <span class="token operator">=</span> templateNpm<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">async</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断项目模板是否存在</span>
        <span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getProjectTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">||</span> template<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'项目模板不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>template <span class="token operator">=</span> template<span class="token punctuation">;</span>
        <span class="token comment">//1.判断当前目录是否为空</span>
        <span class="token keyword">const</span> localPath <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDirEmpty</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> ifContinue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//询问是否继续创建</span>
                ifContinue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ifContinue'</span><span class="token punctuation">,</span>
                    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'当前文件夹不为空，是否继续创建项目?'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ifContinue<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ifContinue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//2.是否启动强制更新</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ifContinue <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//给用户二次确认</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> confirmDelete <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'confirmDelete'</span><span class="token punctuation">,</span>
                    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'是否确认清空当前目录下的文件?'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>confirmDelete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//清空当前目录</span>
                    fse<span class="token punctuation">.</span><span class="token function">emptyDirSync</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProjectInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.选择创建项目或组件</span>
        <span class="token comment">//4.获取项目得基本信息</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">getProjectInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">function</span> <span class="token function">isValidName</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z]+([-][a-zA-Z][a-zA-Z0-9]*|[_][a-zA-Z][a-zA-Z0-9]*|[a-zA-Z0-9])*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> projectInfo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> isProjectInfoValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isProjectInfoValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            projectInfo<span class="token punctuation">.</span>projectName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//1.选择创建项目或组件</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'type'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'请选择初始化类型'</span><span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token constant">TYPE_PROJECT</span><span class="token punctuation">,</span>
            <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'项目'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">TYPE_PROJECT</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'组件'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">TYPE_COMPONENT</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">verbose</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">template</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> template<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> title <span class="token operator">=</span> type <span class="token operator">===</span> <span class="token constant">TYPE_PROJECT</span> <span class="token operator">?</span> <span class="token string">'项目'</span> <span class="token operator">:</span> <span class="token string">'组件'</span><span class="token punctuation">;</span>
        <span class="token comment">//2.获取项目的基本信息</span>
        <span class="token keyword">const</span> projectNamePrompt <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'projectName'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的名称</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token function-variable function">validate</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//1.输入的首字符必须为英文字符</span>
                    <span class="token comment">//2.尾字符必须为英文或数字，不能为字符</span>
                    <span class="token comment">//3.字符仅运行&quot;-_&quot;</span>
                    <span class="token comment">//\w = a-zA-Z0-9  *表示0个或多个</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidName</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">done</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入合法的</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">名称</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> v<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> projectPrompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProjectInfoValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>projectNamePrompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'projectVersion'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请输入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">版本号</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">validate</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//1.输入的首字符必须为英文字符</span>
                    <span class="token comment">//2.尾字符必须为英文或数字，不能为字符</span>
                    <span class="token comment">//3.字符仅运行&quot;-_&quot;</span>
                    <span class="token comment">//\w = a-zA-Z0-9  *表示0个或多个</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">'请输入合法的版本号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> semver<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'projectTemplate'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请选择</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">模板</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTemplateChoices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">TYPE_PROJECT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> project <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>projectPrompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            projectInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>projectInfo<span class="token punctuation">,</span>
                type<span class="token punctuation">,</span>
                <span class="token operator">...</span>project
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">TYPE_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> descriptionPrompt <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'componentDescription'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'请输入组件描述信息'</span><span class="token punctuation">,</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                <span class="token function-variable function">validate</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//1.输入的首字符必须为英文字符</span>
                        <span class="token comment">//2.尾字符必须为英文或数字，不能为字符</span>
                        <span class="token comment">//3.字符仅运行&quot;-_&quot;</span>
                        <span class="token comment">//\w = a-zA-Z0-9  *表示0个或多个</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">'请输入组件描述信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            projectPrompt<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>descriptionPrompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>projectPrompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            projectInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>projectInfo<span class="token punctuation">,</span>
                type<span class="token punctuation">,</span>
                <span class="token operator">...</span>component
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//return 项目的基本信息(object)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            projectInfo<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'kebab-case'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^-</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>projectVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            projectInfo<span class="token punctuation">.</span>version <span class="token operator">=</span> projectInfo<span class="token punctuation">.</span>projectVersion<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>projectInfo<span class="token punctuation">.</span>componentDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            projectInfo<span class="token punctuation">.</span>description <span class="token operator">=</span> projectInfo<span class="token punctuation">.</span>componentDescription<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> projectInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">isDirEmpty</span><span class="token punctuation">(</span><span class="token parameter">localPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fileList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//文件过滤的逻辑</span>
        fileList <span class="token operator">=</span> fileList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token operator">!</span>fileList <span class="token operator">||</span> fileList<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">createTemplateChoices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> item<span class="token punctuation">.</span>npmName<span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> item<span class="token punctuation">.</span>name
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('init',projectName,cmdObj.force,process.env.CLI_TARGET_PATH);</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InitCommand</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> init<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>InitCommand <span class="token operator">=</span> InitCommand<span class="token punctuation">;</span>
</code></pre></div><p>至此我们完成了脚手架开发以及通过脚手架创建项目。</p> <h2 id="附"><a href="#附" class="header-anchor">#</a> 附</h2> <h3 id="如何通过yargs来开发脚手架"><a href="#如何通过yargs来开发脚手架" class="header-anchor">#</a> 如何通过Yargs来开发脚手架?</h3> <ul><li><p>脚手架分为三部分构成(vue create vuex)</p> <ul><li>bin:主命令在package.json中配置bin属性，npm link本地安装</li> <li>command:命令</li> <li>options:参数(boolean/string/number)</li> <li>文件顶部增加<code>#!/usr/bin/env node</code>,这行命令的用途时告诉操作系统要在环境变量当中查询到node命令,通过node命令来执行文件</li></ul></li> <li><p>脚手架初始化流程</p> <ul><li>构造函数:Yargs()  (通过Yargs构造函数的调用去生成一个脚手架)</li> <li>常用方法:
<ul><li>Yargs.options (注册脚手架的属性)</li> <li>Yargs.option</li> <li>Yargs.group (将脚手架属性进行分组)</li> <li>Yargs.demandCommand (规定最少传几个command)</li> <li>Yargs.recommendCommands (在输入错误command以后可以给你推荐最接近的正确的command)</li> <li>Yargs.strict (开启以后可以报错提示)</li> <li>Yargs.fail (监听脚手架的异常)</li> <li>Yargs.alias (起别名)</li> <li>Yargs.wrapper (命令行工具的宽度)</li> <li>Yargs.epilogus (命令行工具底部的提示)</li></ul></li></ul></li> <li><p>脚手架参数解析方法</p> <ul><li>hideBin(process.argv)</li> <li>Yargs.parse(argv, options)</li></ul></li> <li><p>命令注册方法</p> <ul><li>Yargs.command(command,describe, builder, handler)</li> <li>Yargs.command({command,describe, builder, handler})</li></ul></li></ul> <h3 id="node-js模块路径解析流程"><a href="#node-js模块路径解析流程" class="header-anchor">#</a> Node.js模块路径解析流程</h3> <ul><li>Node.js项目模块路径解析是通过<code>require.resolve</code>方法来实现的</li> <li><code>require.resolve</code>就是通过<code>Module._resolveFileName</code>方法实现的</li> <li><code>require.resolve</code>实现原理:
<ul><li><code>Module._resolveFileName</code>方法核心流程有3点:
<ul><li>判断是否为内置模块</li> <li>通过<code>Module._resolveLookupPaths</code>方法生成node_modules可能存在的路径</li> <li>通过<code>Module._findPath</code>查询模块的真实路径</li></ul></li> <li><code>Module._findPath</code>核心流程有4点:
<ul><li>查询缓存(将request和paths通过<code>\x00</code>(空格)合并成cacheKey)</li> <li>遍历paths,将path与request组成文件路径basePath</li> <li>如果basePath存在则调用<code>fs.realPathSync</code>获取文件真实路径</li> <li>将文件真实路径缓存到<code>Module._pathCache</code>(key就是前面生成的cacheKey)</li></ul></li> <li><code>fs.realPathSync</code>核心流程有3点:
<ul><li>查询缓存(缓存的key为p，即<code>Module._findPath</code>中生成的文件路径)</li> <li>从左往右遍历路径字符串，查询到<code>/</code>时，拆分路径，判断该路径是否为软连接，如果是软连接则查询真实链接，并生成新路径p，然后继续往后遍历，这里有1个细节需要注意:
<ul><li>遍历过程中生成的子路径base会缓存在knownHard和cache中，避免重复查询</li></ul></li> <li>遍历完成得到模块对应的真实路径，此时会将原路径original作为key，真实路径作为value，保存到缓存中</li></ul></li></ul></li> <li><code>require.resolve.paths</code>等价于<code>Module._resolveLoopupPaths</code>,该方法用于获取所有的node_modules可能存在的路径</li> <li><code>require.resolve.paths</code>实现原理:</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/25/2021, 3:56:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/vue3/权限管理.html" class="prev">
        权限管理
      </a></span> <span class="next"><a href="/note/modular/自动化部署.html">
        自动化部署
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.61a85b1c.js" defer></script><script src="/assets/js/2.6b359b12.js" defer></script><script src="/assets/js/67.74bf1c32.js" defer></script>
  </body>
</html>
