<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>node搭建 | 码农机器人</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="努力向前">
    
    <link rel="preload" href="/assets/css/0.styles.b8d0645b.css" as="style"><link rel="preload" href="/assets/js/app.61a85b1c.js" as="script"><link rel="preload" href="/assets/js/2.6b359b12.js" as="script"><link rel="preload" href="/assets/js/69.5b78d6fb.js" as="script"><link rel="prefetch" href="/assets/js/10.6bf522d2.js"><link rel="prefetch" href="/assets/js/100.a249a4e9.js"><link rel="prefetch" href="/assets/js/101.9d2465ad.js"><link rel="prefetch" href="/assets/js/102.5ea0ea92.js"><link rel="prefetch" href="/assets/js/103.ad073f03.js"><link rel="prefetch" href="/assets/js/104.afd1455c.js"><link rel="prefetch" href="/assets/js/105.5429d9b6.js"><link rel="prefetch" href="/assets/js/106.012719c5.js"><link rel="prefetch" href="/assets/js/107.fa002f10.js"><link rel="prefetch" href="/assets/js/108.9c70864a.js"><link rel="prefetch" href="/assets/js/109.ab6712ef.js"><link rel="prefetch" href="/assets/js/11.07adb038.js"><link rel="prefetch" href="/assets/js/110.3496849e.js"><link rel="prefetch" href="/assets/js/111.0708cccd.js"><link rel="prefetch" href="/assets/js/112.3ddda9ff.js"><link rel="prefetch" href="/assets/js/113.a826b4ec.js"><link rel="prefetch" href="/assets/js/114.54f06bf1.js"><link rel="prefetch" href="/assets/js/115.68bd2270.js"><link rel="prefetch" href="/assets/js/116.0e283e33.js"><link rel="prefetch" href="/assets/js/117.10ca7c11.js"><link rel="prefetch" href="/assets/js/118.0f21544b.js"><link rel="prefetch" href="/assets/js/119.3d5cdaf0.js"><link rel="prefetch" href="/assets/js/12.6a633ec9.js"><link rel="prefetch" href="/assets/js/13.2e8873e5.js"><link rel="prefetch" href="/assets/js/14.0ea5ac55.js"><link rel="prefetch" href="/assets/js/15.d24d1240.js"><link rel="prefetch" href="/assets/js/16.bfb99431.js"><link rel="prefetch" href="/assets/js/17.0bf6db21.js"><link rel="prefetch" href="/assets/js/18.f6a16197.js"><link rel="prefetch" href="/assets/js/19.15b1e095.js"><link rel="prefetch" href="/assets/js/20.56746f5a.js"><link rel="prefetch" href="/assets/js/21.5019bb92.js"><link rel="prefetch" href="/assets/js/22.36a83eaf.js"><link rel="prefetch" href="/assets/js/23.c1d826fa.js"><link rel="prefetch" href="/assets/js/24.66437f58.js"><link rel="prefetch" href="/assets/js/25.b5ef9760.js"><link rel="prefetch" href="/assets/js/26.1e34c193.js"><link rel="prefetch" href="/assets/js/27.ea4375e5.js"><link rel="prefetch" href="/assets/js/28.8e440e91.js"><link rel="prefetch" href="/assets/js/29.ffd2070e.js"><link rel="prefetch" href="/assets/js/3.a6d8cb97.js"><link rel="prefetch" href="/assets/js/30.c1451f4e.js"><link rel="prefetch" href="/assets/js/31.a21ecc83.js"><link rel="prefetch" href="/assets/js/32.5d1de9ff.js"><link rel="prefetch" href="/assets/js/33.f9eef1d1.js"><link rel="prefetch" href="/assets/js/34.edb8fde2.js"><link rel="prefetch" href="/assets/js/35.6950ed93.js"><link rel="prefetch" href="/assets/js/36.b394a848.js"><link rel="prefetch" href="/assets/js/37.f11aa33f.js"><link rel="prefetch" href="/assets/js/38.e86bdf7f.js"><link rel="prefetch" href="/assets/js/39.dbc9c882.js"><link rel="prefetch" href="/assets/js/4.f3783df1.js"><link rel="prefetch" href="/assets/js/40.470a2b37.js"><link rel="prefetch" href="/assets/js/41.bcffb885.js"><link rel="prefetch" href="/assets/js/42.484ee502.js"><link rel="prefetch" href="/assets/js/43.2a86b409.js"><link rel="prefetch" href="/assets/js/44.2b684e4d.js"><link rel="prefetch" href="/assets/js/45.4e6fb818.js"><link rel="prefetch" href="/assets/js/46.86268f46.js"><link rel="prefetch" href="/assets/js/47.84f7cda3.js"><link rel="prefetch" href="/assets/js/48.fd78be04.js"><link rel="prefetch" href="/assets/js/49.f5a6fc1e.js"><link rel="prefetch" href="/assets/js/5.892f2cf8.js"><link rel="prefetch" href="/assets/js/50.29919944.js"><link rel="prefetch" href="/assets/js/51.c1b5918c.js"><link rel="prefetch" href="/assets/js/52.c4ad64f8.js"><link rel="prefetch" href="/assets/js/53.df154372.js"><link rel="prefetch" href="/assets/js/54.4fee1b96.js"><link rel="prefetch" href="/assets/js/55.18c6e9f2.js"><link rel="prefetch" href="/assets/js/56.d5569485.js"><link rel="prefetch" href="/assets/js/57.9eb74b69.js"><link rel="prefetch" href="/assets/js/58.c8b7968e.js"><link rel="prefetch" href="/assets/js/59.a208d99c.js"><link rel="prefetch" href="/assets/js/6.a9a81823.js"><link rel="prefetch" href="/assets/js/60.c0f7048b.js"><link rel="prefetch" href="/assets/js/61.e06e2c12.js"><link rel="prefetch" href="/assets/js/62.3726a0b9.js"><link rel="prefetch" href="/assets/js/63.53a81692.js"><link rel="prefetch" href="/assets/js/64.ba6af384.js"><link rel="prefetch" href="/assets/js/65.2f165ffa.js"><link rel="prefetch" href="/assets/js/66.8c0a983a.js"><link rel="prefetch" href="/assets/js/67.74bf1c32.js"><link rel="prefetch" href="/assets/js/68.27c15e0b.js"><link rel="prefetch" href="/assets/js/7.a9e85c97.js"><link rel="prefetch" href="/assets/js/70.4772f9bd.js"><link rel="prefetch" href="/assets/js/71.2a2e89e4.js"><link rel="prefetch" href="/assets/js/72.3debedf0.js"><link rel="prefetch" href="/assets/js/73.c9ee93ce.js"><link rel="prefetch" href="/assets/js/74.7ec9495c.js"><link rel="prefetch" href="/assets/js/75.8c828ff5.js"><link rel="prefetch" href="/assets/js/76.986dc0d7.js"><link rel="prefetch" href="/assets/js/77.7e7e3c8e.js"><link rel="prefetch" href="/assets/js/78.200d9828.js"><link rel="prefetch" href="/assets/js/79.ee6b28e9.js"><link rel="prefetch" href="/assets/js/8.448002b9.js"><link rel="prefetch" href="/assets/js/80.93d03d67.js"><link rel="prefetch" href="/assets/js/81.eebcba15.js"><link rel="prefetch" href="/assets/js/82.3b0bb838.js"><link rel="prefetch" href="/assets/js/83.75234d18.js"><link rel="prefetch" href="/assets/js/84.1a897e55.js"><link rel="prefetch" href="/assets/js/85.8267b168.js"><link rel="prefetch" href="/assets/js/86.a7557c20.js"><link rel="prefetch" href="/assets/js/87.4f7e77b3.js"><link rel="prefetch" href="/assets/js/88.9b41f10e.js"><link rel="prefetch" href="/assets/js/89.662b9425.js"><link rel="prefetch" href="/assets/js/9.804860d0.js"><link rel="prefetch" href="/assets/js/90.6d84e2d8.js"><link rel="prefetch" href="/assets/js/91.650a7b6f.js"><link rel="prefetch" href="/assets/js/92.8568032c.js"><link rel="prefetch" href="/assets/js/93.0c300b40.js"><link rel="prefetch" href="/assets/js/94.f7ce23ff.js"><link rel="prefetch" href="/assets/js/95.e6c8272f.js"><link rel="prefetch" href="/assets/js/96.8f51c3ac.js"><link rel="prefetch" href="/assets/js/97.9cc683f5.js"><link rel="prefetch" href="/assets/js/98.6af1269f.js"><link rel="prefetch" href="/assets/js/99.97a09de8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b8d0645b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="码农机器人" class="logo"> <span class="site-name can-hide">码农机器人</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>建立前端知识体系</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/handwritten/手写.html" class="sidebar-link">手写</a></li><li><a href="/note/knowledge/JS数据类型.html" class="sidebar-link">JS数据类型</a></li><li><a href="/note/knowledge/变量、作用域、内存问题.html" class="sidebar-link">变量、作用域、内存问题</a></li><li><a href="/note/knowledge/复杂数据类型.html" class="sidebar-link">复杂数据类型</a></li><li><a href="/note/knowledge/JS原型-原型链.html" class="sidebar-link">JS原型-原型链</a></li><li><a href="/note/knowledge/函数表达式.html" class="sidebar-link">函数表达式</a></li><li><a href="/note/knowledge/事件循环机制EventLoop.html" class="sidebar-link">事件循环机制EventLoop</a></li><li><a href="/note/knowledge/深拷贝、浅拷贝.html" class="sidebar-link">深拷贝、浅拷贝</a></li><li><a href="/note/knowledge/迭代器.html" class="sidebar-link">迭代器</a></li><li><a href="/note/knowledge/tcp.html" class="sidebar-link">TCP三次握手，四次挥手</a></li><li><a href="/note/knowledge/HTTPS和HTTP2.0.html" class="sidebar-link">HTTPS和HTTP2.0</a></li><li><a href="/note/knowledge/call,apply,bind,new的内部原理实现.html" class="sidebar-link">call,apply,bind,new的内部原理实现</a></li><li><a href="/note/knowledge/JavaScript工作原理.html" class="sidebar-link">JavaScript工作原理</a></li><li><a href="/note/knowledge/元编程.html" class="sidebar-link">元编程</a></li><li><a href="/note/knowledge/JS基础.html" class="sidebar-link">JavaScript 基础</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提效赋能 前端工程化篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>程序员PLUS篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>忍者秘籍书</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node搭建"><a href="#node搭建" class="header-anchor">#</a> node搭建</h1> <h2 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h2> <div class="language-js extra-class"><pre class="language-js"><code>npm init <span class="token operator">-</span>y
</code></pre></div><p>创建一个package.json文件,然后在下面创建如下目录和app.js</p> <p><img src="/node/1609512672431.jpg" alt=""></p> <h2 id="安装koa依赖"><a href="#安装koa依赖" class="header-anchor">#</a> 安装koa依赖</h2> <div class="language-js extra-class"><pre class="language-js"><code>npm install koa <span class="token operator">--</span>save
</code></pre></div><p>安装完成后去app.js里面引用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div> <h2 id="使用-nodemon-启动调试"><a href="#使用-nodemon-启动调试" class="header-anchor">#</a> 使用 nodemon 启动调试</h2> <p>nodemon 用来监视node.js应用程序中的任何更改并自动重启服务,不需要我们每次改了代码手动重启。</p> <p>全局安装 nodemon</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install nodemon <span class="token operator">-</span>g <span class="token comment">//报错就用sudo npm install nodemon -g 然后输入密码</span>
</code></pre></div><p>执行 <code>nodemon app.js</code>,得到如下结果说明成功</p> <p><img src="/node/1609514859156.jpg" alt=""></p> <h2 id="环境变量配置"><a href="#环境变量配置" class="header-anchor">#</a> 环境变量配置</h2> <p>我们可以在config目录下新建一个<code>index.js</code>,想要根据mode环境来执行不同得配置，我们需要先安装一个lodash，安装命令:<code>npm install lodash -S</code>，安装完成后在<code>index.js</code>里面编写如下代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>extend<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> localConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">8081</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> proConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>proConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config<span class="token punctuation">;</span>
</code></pre></div><p>我们去app.js里面引入该配置，<code>const {port} = require('./config')</code>,然后把监听得3000端口改成port。</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>我们现在想要看到该环境信息是否正确，那么就要先安装一个<code>npm install cross-env --save</code>, <strong>cross-env</strong> 这是一款运行跨平台设置和使用环境变量的脚本。</p> <p>安装完成后，去package.json里面得scripts对象下面去配置一行命令:<code>&quot;start&quot;: &quot;cross-env NODE_ENV=development nodemon app.js&quot;</code></p> <p>执行<code>npm start</code>,去浏览器打开<code>http://localhost:8081/</code>发现能正常访问了，说明我们环境变量配置成功了。</p> <h2 id="路由以及部署项目到node"><a href="#路由以及部署项目到node" class="header-anchor">#</a> 路由以及部署项目到node</h2> <p>安装插件:</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install koa<span class="token operator">-</span>simple<span class="token operator">-</span>router <span class="token operator">--</span>save
npm install koa<span class="token operator">-</span>swig <span class="token operator">--</span>save <span class="token comment">//模板引擎</span>
</code></pre></div><p>我们通过在controllers目录下创建<code>index.js ApiController.js Controller.js</code>,</p> <p>在ApiController.js代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'欢迎来到Node'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在index.js代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-simple-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ApiController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ApiController'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> apiController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
        <span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/actionIndex'</span><span class="token punctuation">,</span>apiController<span class="token punctuation">.</span>actionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>我们需要在app.js里面加入一些配置，完整代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> port<span class="token punctuation">,</span>memoryFlag<span class="token punctuation">,</span>viewDir <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">root</span><span class="token operator">:</span> viewDir<span class="token punctuation">,</span>
        <span class="token literal-property property">autoescape</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cache</span><span class="token operator">:</span> memoryFlag<span class="token punctuation">,</span> <span class="token comment">// disable, set to false</span>
        <span class="token literal-property property">ext</span><span class="token operator">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">writeBody</span><span class="token operator">:</span><span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>运行<code>npm start</code>后，访问<code>http://localhost:8081/api/actionIndex</code>,在页面上显示<code>欢迎来到Node</code>，说明成功。</p> <h3 id="node启动项目"><a href="#node启动项目" class="header-anchor">#</a> Node启动项目</h3> <p>首先通过vue创建一个空项目，然后打包成dist，把dist里面得文件拷贝到node文件加中，如下图:</p> <p><img src="/node/1609556226894.jpg" alt=""></p> <p>需要在<code>ApiController.js</code>里面加入如下代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">actionRender</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后去controller目录下<code>index.js</code>里面加入一个路由，<code>_.get('/',apiController.actionRender)</code>,表示我们通过<code>http://localhost:8081/</code>就能访问到我们得项目</p> <p>但是这样直接访问就会有一个问题，那就是静态资源路径找不到，这时候我们就要借助一个插件来处理这么报错，在终端中输入如下命令:<code>npm install koa-static --save</code></p> <p>安装完成后我们去修改<code>app.js</code>里面得内容，如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-swig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> port<span class="token punctuation">,</span>memoryFlag<span class="token punctuation">,</span>viewDir<span class="token punctuation">,</span>staticDir <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">server</span><span class="token punctuation">(</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">root</span><span class="token operator">:</span> viewDir<span class="token punctuation">,</span>
        <span class="token literal-property property">autoescape</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cache</span><span class="token operator">:</span> memoryFlag<span class="token punctuation">,</span> <span class="token comment">// disable, set to false</span>
        <span class="token literal-property property">ext</span><span class="token operator">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">writeBody</span><span class="token operator">:</span><span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controllers'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>值得注意的是，我们从config目录下引入了一下参数，最开始我们说config目录下是配置各种公共参数和环境变量，那么我们来看下这些参数都配置了什么，代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>extend<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">viewDir</span><span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span><span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticDir</span><span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span><span class="token string">'assets'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> localConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">8081</span><span class="token punctuation">,</span>

        <span class="token literal-property property">memoryFlag</span><span class="token operator">:</span><span class="token string">'memory'</span>
    <span class="token punctuation">}</span>
    config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> proConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token literal-property property">memoryFlag</span><span class="token operator">:</span><span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>proConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config<span class="token punctuation">;</span>
</code></pre></div><p>我们再去访问<code>http://localhost:8081/</code>，发现可以访问我们得项目</p> <p><img src="/node/1609556980218.jpg" alt=""></p> <p><img src="/node/1609557026347.jpg" alt=""></p> <p>点击按钮，路由也能正常跳转。</p> <p>但是这里会引发一个问题，这里我们可以看到我们访问得项目后，路由会自动带有<code>#</code>，那是因为vue打包的时候把路由模式设置得参数是<code>mode:'hash'</code>,我们在about页面如何刷新都能正常访问，那么如果把路由模式改成<code>mode:'history'</code>，路由路径里面不会带<code>#</code>,那么在about页面刷新页面就会报错<code>Not Found</code>，这是为什么呢？原因很简单，这里涉及到真假路由问题，我们可以通过node里面修改这个问题或者通过nginx做来处理。</p> <h3 id="node中如何解决vue-router使用history模式呢"><a href="#node中如何解决vue-router使用history模式呢" class="header-anchor">#</a> node中如何解决vue-router使用history模式呢？</h3> <p>安装一下依赖<code>npm install koa2-connect-history-api-fallback --save</code>,</p> <p>koa2的一个中间件，用于处理vue-router使用history模式返回index.html，让koa2支持SPA应用程序</p> <p>在<code>app.js</code>里面加入如下代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> historyApiFallback <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-connect-history-api-fallback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//需要写在require('./controllers')(app);之前</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后<code>mode:'history'</code>模式得路由就可以访问了，刷新也正常显示。</p> <h2 id="koa-全局异常处理"><a href="#koa-全局异常处理" class="header-anchor">#</a> Koa 全局异常处理</h2> <h3 id="异常得概念"><a href="#异常得概念" class="header-anchor">#</a> 异常得概念</h3> <p>对于异常，我们可以分为已知异常和未知异常</p> <p>已知异常就是程序中能够知道得异常，如:客户端参数传递错误，服务端抛出异常，如客户端无权访问等等这类，这类错误就是已知异常。</p> <p>未知异常就是程序中不能预想得错误，最常见得服务器程序抛出状态码500得异常。如比如我们单词拼写错误，导致程序无法运行等等，这种就是未知异常。</p> <p>新建一个middlewares文件夹，在下面创建一个<code>errorHandler.js</code>文件，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">errorHandler</span><span class="token punctuation">{</span>
     <span class="token keyword">static</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span>logger</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
             <span class="token keyword">try</span> <span class="token punctuation">{</span>
                 <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
             <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">404</span><span class="token operator">!==</span>ctx<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">return</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;script type=&quot;text/javascript&quot; src=&quot;//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;'</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 module<span class="token punctuation">.</span>exports <span class="token operator">=</span> errorHandler<span class="token punctuation">;</span>
</code></pre></div><p>在app.js里面导入模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> errorHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middlewares/errorHandler'</span><span class="token punctuation">)</span>
<span class="token comment">//在这两个之前app.use(historyApiFallback({index:'/', whiteList: ['/api'] }));</span>
<span class="token comment">// require('./controllers')(app);</span>
errorHandler<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="定义异常得返回结果"><a href="#定义异常得返回结果" class="header-anchor">#</a> 定义异常得返回结果</h3> <p>类似没有定义直接用的变量是空值，导致空指针异常，这类肯定是属于我们前面说的未知异常。那我们怎么区分是已知还是未知呢？</p> <p>在服务器接口开发中，一个异常得返回结果，通常包含有:</p> <ul><li>msg:异常信息</li> <li>code:HTTP状态码</li> <li>errorCode:自定义的异常状态码</li></ul> <p>因此我们可以定义HttpException只要是出现这异常属于HttpException都属于已知异常。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义HttpException继承Error这个类</span>
<span class="token keyword">class</span> <span class="token class-name">HttpException</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>msg <span class="token operator">=</span> <span class="token string">'服务器异常'</span><span class="token punctuation">,</span> errorCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">/**
         * 错误信息
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg
        <span class="token comment">/**
         * Http 状态码
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code
        <span class="token comment">/**
         * 自定义的异常状态码
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们改写下中间件那里，区分是已知异常还是未知异常</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> HttpException <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./httpException&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">errorHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> isHttpException <span class="token operator">=</span> error <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span>
                <span class="token comment">//判断是否是已知错误</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isHttpException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
                        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
                        <span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span>
                    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>code
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'服务器出现了未知异常'</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> <span class="token number">999</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span>
                    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">404</span> <span class="token operator">!==</span> ctx<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;script type=&quot;text/javascript&quot; src=&quot;//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> errorHandler<span class="token punctuation">;</span>
</code></pre></div><p>Ok,我们现在测试下</p> <p>我们启动服务 访问 http://localhost:8000/ 发现抛出了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;服务器出现了未知异常&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;errorCode&quot;</span><span class="token operator">:</span><span class="token number">999</span><span class="token punctuation">,</span><span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span><span class="token string">&quot;GET /&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>说明我们自定义的中间件已经捕拦截到异常错误了</p> <h3 id="定义常见的异常状态"><a href="#定义常见的异常状态" class="header-anchor">#</a> 定义常见的异常状态</h3> <p>有了上面的 异常的基类，我们很容易定义一些常见的异常，如：参数校验失败</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ParameterExceptio</span> <span class="token keyword">extends</span> <span class="token class-name">HttpException</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> errorCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'参数错误'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode <span class="token operator">||</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>成功返回</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Success</span> <span class="token keyword">extends</span> <span class="token class-name">HttpException</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> errorCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'成功'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode <span class="token operator">||</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>权限认证</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">AuthFaild</span> <span class="token keyword">extends</span> <span class="token class-name">HttpException</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'认证失败'</span>；
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> <span class="token number">1004</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="bff"><a href="#bff" class="header-anchor">#</a> BFF</h2> <h3 id="什么是bff以及node-js在bff层能做的事情"><a href="#什么是bff以及node-js在bff层能做的事情" class="header-anchor">#</a> 什么是BFF以及node.js在BFF层能做的事情</h3> <p><strong>BFF-服务于前端的后端</strong> 。比如，现在有一个后端接口，他不满足我前端要求的格式，或者很多无用的数据格式，那么我们就可以在 <strong>BFF</strong> 层把数据格式化。</p> <h3 id="在node的模板渲染"><a href="#在node的模板渲染" class="header-anchor">#</a> 在Node的模板渲染</h3> <p>我们在views目录下新建一个<code>index.html</code>，在<code>body</code>标签加入<code>&lt;h1&gt;[[data]]&lt;/h1&gt;</code>,然后去app.js里面加入<code>varControls: ['[[', ']]']</code>，如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">root</span><span class="token operator">:</span> viewDir<span class="token punctuation">,</span>
        <span class="token literal-property property">autoescape</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cache</span><span class="token operator">:</span> memoryFlag<span class="token punctuation">,</span> <span class="token comment">// disable, set to false</span>
        <span class="token literal-property property">ext</span><span class="token operator">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">writeBody</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">varControls</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'[['</span><span class="token punctuation">,</span> <span class="token string">']]'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后在接口路由里面代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">actionRender</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token string">&quot;后端数据&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们访问<code>http://localhost:8081/</code>就可以看到页面上显示我们想要的数据了。</p> <p><img src="/node/1609595307925.jpg" alt=""></p> <h2 id="js-type-module-和-systemjs"><a href="#js-type-module-和-systemjs" class="header-anchor">#</a> JS type module 和 systemjs</h2> <p>使用JavaScript模块依赖于 <strong>import</strong> 和 <strong>export</strong> ,最新的浏览器开始原生支持模块功能了，浏览器能够最优化加载模块，是它比使用库更有效率:使用库通常需要做额外的客户端处理。</p> <p>首先，你需要把type=&quot;module&quot;放到 <strong>script</strong> 标签中，来声明这个脚本是一个模板:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
    <span class="token comment">// 1.支持module 支持nomodule</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./js/data.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>浏览器中可用的JavaScript模块功能的最新部分是动态模块加载。这允许你仅在需要时动态加载模块，而不必预先加载所有模块。如上</p> <p>那如果浏览器不支持 <strong>module</strong> 呢，支持 <strong>nomodule</strong> 如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">'nomodule'</span><span class="token operator">&gt;</span>
    <span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>这时候我们就需要用 <strong>balel</strong>进行打包编译</p> <p>如果浏览器既不支持 <strong>module</strong> 也不支持 <strong>nomodule</strong> 这个时候我们需要用到 <strong>systemjs</strong></p> <h3 id="安装依赖"><a href="#安装依赖" class="header-anchor">#</a> 安装依赖</h3> <div class="language-js extra-class"><pre class="language-js"><code>npm install @babel<span class="token operator">/</span>cli @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>modules<span class="token operator">-</span>systemjs @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><h3 id="配置-babelrc"><a href="#配置-babelrc" class="header-anchor">#</a> 配置.babelrc</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;@babel/preset-env&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;@babel/plugin-transform-modules-systemjs&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="执行打包"><a href="#执行打包" class="header-anchor">#</a> 执行打包</h3> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token string-property property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel ./assets/scripts/data.js -o ./assets/scripts/data_bundle.js&quot;</span>
</code></pre></div><blockquote><p>systemjs 是一个 通用模块加载器，支持AMD、Commonjs、ES6等各种格式的js模块加载</p></blockquote> <p>在index.html引入systemjs</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script nomodule src<span class="token operator">=</span><span class="token string">&quot;https://cdn.staticfile.org/systemjs/6.3.3/system.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script nomodule<span class="token operator">&gt;</span>
    <span class="token comment">// 不支持module 不支持nomodule 下面</span>
    System<span class="token punctuation">.</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string">&quot;./scripts/data_bundle.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>最坑的来了, 如果 支持 module 不支持 nomodule,那我们上面的代码会执行2次,那么怎么解决呢</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> check <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'noModule'</span> <span class="token keyword">in</span> check<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'onbeforeload'</span> <span class="token keyword">in</span> check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> support <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target <span class="token operator">===</span> check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    support <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'nomodule'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>support<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            check<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'module'</span><span class="token punctuation">;</span>
            check<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">;</span>
            check<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>总结如下:</p> <ul><li>支持module 支持nomodule</li> <li>支持module 不支持nomodule xx 代码会执行2次</li> <li>不支持module 不支持nomodule</li></ul> <h2 id="node链接数据库"><a href="#node链接数据库" class="header-anchor">#</a> node链接数据库</h2> <h3 id="安装依赖-2"><a href="#安装依赖-2" class="header-anchor">#</a> 安装依赖</h3> <div class="language-js extra-class"><pre class="language-js"><code>npm install sequelize mysql2 <span class="token operator">--</span>save
</code></pre></div><h3 id="初始化-sequelize"><a href="#初始化-sequelize" class="header-anchor">#</a> 初始化 Sequelize</h3> <p>在config目录下新建一个<code>sql.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> database<span class="token punctuation">,</span> host<span class="token punctuation">,</span> sqlPort<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Op <span class="token operator">=</span> Sequelize<span class="token punctuation">.</span>Op<span class="token punctuation">;</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span>sqlPort<span class="token punctuation">,</span>
    host<span class="token punctuation">,</span>
    <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pool</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">acquire</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
        <span class="token literal-property property">idle</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">operatorsAliases</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">$and</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>and<span class="token punctuation">,</span>
        <span class="token literal-property property">$or</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>or<span class="token punctuation">,</span>
        <span class="token literal-property property">$eq</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>eq<span class="token punctuation">,</span>
        <span class="token literal-property property">$gt</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>gt<span class="token punctuation">,</span>
        <span class="token literal-property property">$lt</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>lt<span class="token punctuation">,</span>
        <span class="token literal-property property">$lte</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>lte<span class="token punctuation">,</span>
        <span class="token literal-property property">$like</span><span class="token operator">:</span> Op<span class="token punctuation">.</span>like
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dialectOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 字符集</span>
        <span class="token literal-property property">charset</span><span class="token operator">:</span> <span class="token string">&quot;utf8mb4&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">collate</span><span class="token operator">:</span> <span class="token string">&quot;utf8mb4_unicode_ci&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">supportBigNumbers</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">bigNumberStrings</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">'+08:00'</span> <span class="token comment">//时区转换</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sequelize<span class="token punctuation">;</span>
</code></pre></div><h3 id="定义一个测试数据模型"><a href="#定义一个测试数据模型" class="header-anchor">#</a> 定义一个测试数据模型</h3> <p>在model目录下创建一个<code>test.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/sql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 model</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userName</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 指定值的类型</span>
        <span class="token literal-property property">field</span><span class="token operator">:</span> <span class="token string">'user_name'</span> <span class="token comment">// 指定存储在表中的键名称</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 没有指定 field，表中键名称则与对象键名相同，为 email</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果为 true 则表的名称和 model 相同，即 user</span>
    <span class="token comment">// 为 false MySQL创建的表名称会是复数 users</span>
    <span class="token comment">// 如果指定的表名称本就是复数形式则不变</span>
    <span class="token literal-property property">freezeTableName</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果不存在就创建此表</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// module.exports = user;</span>
<span class="token comment">// 添加新用户</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">addUser</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">userName<span class="token punctuation">,</span> email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向 user 表中插入数据</span>
    <span class="token keyword">return</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">userName</span><span class="token operator">:</span> userName<span class="token punctuation">,</span>
        <span class="token literal-property property">email</span><span class="token operator">:</span> email
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">findOne</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">userName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">userName</span><span class="token operator">:</span> userName<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="测试方法"><a href="#测试方法" class="header-anchor">#</a> 测试方法</h3> <p>在controller目录下创建一个<code>TestController.js</code>目录:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Test'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> resFind <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token string">'roy1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resFind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> resSave <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token string">'roy1'</span><span class="token punctuation">,</span> <span class="token string">'jack@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'请求成功'</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'保存失败'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'用户名已经存在'</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> TestController<span class="token punctuation">;</span>
</code></pre></div><h3 id="添加路由访问"><a href="#添加路由访问" class="header-anchor">#</a> 添加路由访问</h3> <p>在controller目录下的index.js路由里面添加一行<code>_.get('/api/test', testController.add)</code>,</p> <p>然后运行<code>node start</code>，在浏览器输入<code>http://localhost:8081/api/test</code>，终端打印如下:</p> <p><img src="/node/1609604880414.jpg" alt=""></p> <p>浏览器显示如下:</p> <p><img src="/node/1609604939059.jpg" alt=""></p> <p>数据库显示如下:</p> <p><img src="/node/1609605019159.jpg" alt=""></p> <p>至此,我们利用 Sequelize 完成了一个简单的操作</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/25/2021, 3:56:53 PM</span></div></footer> <!----> </main></div><div class="global-ui"><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.61a85b1c.js" defer></script><script src="/assets/js/2.6b359b12.js" defer></script><script src="/assets/js/69.5b78d6fb.js" defer></script>
  </body>
</html>
