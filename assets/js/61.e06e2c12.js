(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{364:function(t,s,a){"use strict";a.r(s);var r=a(12),e=Object(r.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"gitlab自动化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab自动化"}},[t._v("#")]),t._v(" gitlab自动化")]),t._v(" "),s("h2",{attrs:{id:"gitlab"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab"}},[t._v("#")]),t._v(" Gitlab")]),t._v(" "),s("p",[t._v("Gitlab是一个开源的版本管理系统，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。它拥有与Github类似的功能，能够浏览源码，管理缺陷和注释，可以管理团队对仓库的访问，它非常易于浏览提交的版本并提供一个文件历史库。团队成员可以利用内置的简单的聊天程序进行交流。它还提供一个代码片段收集功能可以实现代码复用。")]),t._v(" "),s("p",[t._v("GitLab对于系统性能有要求，所以我们需要将克隆出来的虚拟机的内存提高到至少2G以上。")]),t._v(" "),s("h3",{attrs:{id:"gitlab安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab安装"}},[t._v("#")]),t._v(" Gitlab安装")]),t._v(" "),s("p",[t._v("方法一:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("sudo docker run "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("detach \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("hostname localhost \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("222")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name gitlab \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("restart always \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("logs"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n")])])]),s("p",[t._v("localhost:主机名,即虚拟机的ip,8084可以自己定义端口号,restart重启方式,volume目录挂载,gitlab/gitlab-ce:latest镜像名。")]),t._v(" "),s("p",[t._v("方法二:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("docker pull twang2218"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh\n")])])]),s("p",[t._v("等待其拉取，然后在 /home下新建docker目录，再在其下新建gitlab目录，进入gitlab目录，在当前目录下新建docker-compose.yml配置文件，编写内容如下。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("web")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'twang2218/gitlab-ce-zh'")]),t._v("   #gitlab镜像\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" always\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("privileged")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("  #权限\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("hostname")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("       #主机名"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("即虚拟机的ip\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TZ")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Asia/Shanghai'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GITLAB_OMNIBUS_CONFIG")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n            external_url "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v(" #主机名"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("即虚拟机的ip\n            gitlab_rails"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_shell_ssh_port'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),t._v("\n            unicorn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'port'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8888")]),t._v("\n            nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listen_port'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8084:8084'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8443:443'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2222:22'")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./config:/etc/gitlab'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./logs:/var/log/gitlab'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./data:/var/opt/gitlab'")]),t._v("\n")])])]),s("p",[t._v("执行"),s("code",[t._v("docker-compose up")]),t._v("，然后进入等待时间，等它下好了去通过自己设置的虚拟机的ip和端口号访问。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622287438766a.jpg",alt:""}})]),t._v(" "),s("p",[t._v("如果安装过程中有报错权限问题，那么加上"),s("code",[t._v("privileged: true")])]),t._v(" "),s("p",[t._v("查看方式:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("root@iZm5ebvlfc3n55vzckl9ifZ"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("# docker ps\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONTAINER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ID")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMAGE")]),t._v("                         "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COMMAND")]),t._v("                  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CREATED")]),t._v("             "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("STATUS")]),t._v("                 "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORTS")]),t._v("                                                                         "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NAMES")]),t._v("\nddc7d0e214ef        twang2218"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/assets/wrapper"')]),t._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" hours ago        Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hours")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp   gitlab_web_1\n\n")])])]),s("p",[t._v("通过虚拟主机的ip+端口访问，此时需要设置管理员密码，账号为root，密码最少为8位。")]),t._v(" "),s("p",[t._v("登录成功后，如下:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622288085865b.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"项目创建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目创建"}},[t._v("#")]),t._v(" 项目创建")]),t._v(" "),s("p",[t._v("点击 "),s("code",[t._v("+")]),t._v(" 号 --\x3e "),s("code",[t._v("新建项目")])]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/7986413-d97bf80a83e45895c.webp",alt:""}})]),t._v(" "),s("p",[t._v("输入项目名称及描述信息，设置可见等级：私有，内部，公开。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622288467482d.jpg",alt:""}})]),t._v(" "),s("h4",{attrs:{id:"初始化项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#初始化项目"}},[t._v("#")]),t._v(" 初始化项目")]),t._v(" "),s("p",[t._v("我们可以选择通过增加一个README的方式来初始化项目,如下:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622288978567e.jpg",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/7986413-38bb77b9e693be70f.png",alt:""}})]),t._v(" "),s("p",[t._v("创建项目的时候有一个问题，在自己最开始定义了端口号，创建项目的时候会没有端口号，这时候clone项目的时候会访问不了，这时候我们在最开始安装定义目录里面config目录下找到"),s("code",[t._v("gitlab.rb")]),t._v(",编辑它，搜索"),s("code",[t._v("external_url")]),t._v("，没有就添加"),s("code",[t._v("external_url:主机ip+端口号")]),t._v("，有就修改就行了。这时候我们就可以去克隆项目了。当然我们也可以通过下面方法去把项目推送到gitlab上面:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622298003116g.jpg",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622289009680h.jpg",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner"}},[t._v("#")]),t._v(" Gitlab-Runner")]),t._v(" "),s("h3",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("sudo docker run "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("restart always \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock \\\n  gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n")])])]),s("p",[t._v("映射"),s("code",[t._v("/var/run/docker.sock")]),t._v("这个文件是为了让容器可以通过"),s("code",[t._v("/var/run/docker.sock")]),t._v("与"),s("code",[t._v("Docker")]),t._v("守护进程通信，管理其他"),s("code",[t._v("Docker")]),t._v("容器\n"),s("code",[t._v("-v /home/gitlab-runner/config:/etc/gitlab-runner")]),t._v("是将runner的配置文件映射到宿主机"),s("code",[t._v("/home/gitlab-runner/config")]),t._v("方便调整和查看配置")]),t._v(" "),s("p",[t._v("安装完成我们需要去注册Gitlab-Runner。")]),t._v(" "),s("p",[t._v("运行"),s("code",[t._v("docker ps")]),t._v("查看:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("root@iZm5ebvlfc3n55vzckl9ifZ"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab# docker ps\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONTAINER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ID")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMAGE")]),t._v("                         "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COMMAND")]),t._v("                  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CREATED")]),t._v("             "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("STATUS")]),t._v("                 "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORTS")]),t._v("                                                                         "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NAMES")]),t._v("\ned6c7a038263        gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest   "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/dumb-init …"')]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" hours ago        Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" hours                                                                                          gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner\nddc7d0e214ef        twang2218"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/assets/wrapper"')]),t._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" hours ago        Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hours")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp   gitlab_web_1\n\n")])])]),s("h3",{attrs:{id:"注册"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册"}},[t._v("#")]),t._v(" 注册")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("docker run "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("rm "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("srv"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner register \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("non"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("interactive \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("executor "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("image alpine"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("url "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("registration"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("token "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("description "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("tag"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("list "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vue3-app"')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("untagged"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("locked"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v(" \\\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("access"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("level"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not_protected"')]),t._v("\n")])])]),s("p",[t._v("注册需要输出url，token，描述，tag，执行器等，url和token怎么来的呢?在设置->CI/CD->Runner里面，我这里面注册了一个专用的和共享的Runner，正常情况我们用专用Runner就可以了。共享版Runner是登录root账户在头部小扳手图片里面的Runner得到url和token，然后去注册。这里面的tag值会在编写"),s("code",[t._v(".gitlab-ci.yml")]),t._v("时用到。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622298841818i.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"运行流水线"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行流水线"}},[t._v("#")]),t._v(" 运行流水线")]),t._v(" "),s("p",[t._v("在项目根目录里面创建一个"),s("code",[t._v(".gitlab-ci.yml")]),t._v("，编写代码如下:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 分段\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" eslint\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 缓存\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" node_modules\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm run build\n")])])]),s("p",[t._v("参数说明:")]),t._v(" "),s("ul",[s("li",[t._v("stages:pipeline的阶段列表，定义整个pipeline阶段")]),t._v(" "),s("li",[t._v("stage:定义某个job的所在阶段")]),t._v(" "),s("li",[t._v("image:指定一个基础Docker进行作为基础运行环境，比如:node,python,java")]),t._v(" "),s("li",[t._v("tags:用于指定Runner，tags的取值范围是在该项目可惜可见的runner tags中，也就是前面我们设置的那个tag")]),t._v(" "),s("li",[t._v("only/except:知道当前任务条件")]),t._v(" "),s("li",[t._v("when:实现在发生故障时仍能运行的作业")]),t._v(" "),s("li",[t._v("cache:讲当前工作环境目录中的一些文件，文件夹存储起来，用于在各个任务初始化的时候恢复")]),t._v(" "),s("li",[t._v("environment:指定部署相关任务的环境，并非真实环境，是对要部署到某环境的任务的归类。方便在gitlab上聚合以便进行回滚和重新部署操作")]),t._v(" "),s("li",[t._v("artifacts:保留文档。在每次 job 之前runner会清除未被 git 跟踪的文件。为了让编译或其他操作后的产物可以留存到后续使用，添加该参数并设置保留的目录，保留时间等。被保留的文件将被上传到gitlab以备后续使用。")]),t._v(" "),s("li",[t._v("dependencies:任务依赖。指定job的前置job。添加该参数后，可以获取到前置job的artifacts。注意如果前置 job 执行失败，导致没能生成artifacts，则 job 也会直接失败。")])]),t._v(" "),s("p",[t._v("编写好上面代码后推送到gitlab后就会自己执行里面的语句:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622299460821j.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),s("p",[t._v("在项目中创建一个"),s("code",[t._v("Dockerfile")]),t._v("，代码如下:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FROM")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("node")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" builder\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("WORKDIR")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("app\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RUN")]),t._v(" npm install "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("registry"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("npm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("taobao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("org\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RUN")]),t._v(" npm run build\n\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FROM")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("nginx")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("from"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("builder "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("dist "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("share"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("html\n")])])]),s("p",[s("code",[t._v(".gitlab-ci.yml")]),t._v("修改如下:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 分段\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" eslint\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 缓存\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" node_modules\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm run build\n\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" docker\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" deploy\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t appimages\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("docker ps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("filter name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" then docker rm "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f app"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("fi\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" docker run "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8082")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name app"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container appimages\n")])])]),s("p",[t._v("if语句判断:使用docker命令去搜索docker容器里面是否有一个name为"),s("code",[t._v("app-container")]),t._v("的容器，如果有就销毁掉,销毁掉是为了使用新的容器重新运行。")]),t._v(" "),s("p",[t._v("这里"),s("code",[t._v("image:docker")]),t._v("不写的话会报错:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622301667720k.jpg",alt:""}})]),t._v(" "),s("p",[t._v("代码推送后，流水线工作，到第三步就会出下报错:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622301866992l.jpg",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622301814039m.jpg",alt:""}})]),t._v(" "),s("p",[t._v("解决办法,在runner配置文件中配置docker命令:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/docker:/usr/bin/docker"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),t._v("\n")])])]),s("p",[t._v("在gitlab-runner->config-vim config.toml，找到注册runner所对应的token，在volumes数组里面加入上面命令:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("concurrent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\ncheck_interval "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("session_server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  session_timeout "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1800")]),t._v("\n  \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v("\n  url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  token "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  executor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("custom_build_dir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gcs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("azure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    tls_verify "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    image "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alpine:latest"')]),t._v("\n    privileged "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    disable_entrypoint_overwrite "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    oom_kill_disable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    disable_cache "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    volumes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/docker:/usr/bin/docker"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    shm_size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),s("p",[t._v("我们在去重新运行失败的Jobs，这时候发现成功了:")]),t._v(" "),s("p",[s("img",{attrs:{src:"/modular/1622302501014n.jpg",alt:""}})]),t._v(" "),s("p",[t._v("然后通过前面注册的端口号去访问，可以正常访问项目。")])])}),[],!1,null,null,null);s.default=e.exports}}]);